Vagrant.configure("2") do |config|
  # Базовая Ubuntu
  config.vm.box = "ubuntu/jammy64"

  # Синхронизация корневой папки проекта
  config.vm.synced_folder "../", "/vagrant", type: "virtualbox"

  # Приватная сеть со статическим IP
  config.vm.network "private_network", ip: "192.168.56.10"

  # Проброс порта для приложения (на хост 5001)
  config.vm.network "forwarded_port", guest: 5000, host: 5001

  # Настройки VirtualBox
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "1024"
    vb.cpus = 1
    vb.name = "devsecops2-vm"
  end

  # SSH
  config.ssh.insert_key = true

  # Provision — автоматическая настройка окружения
  config.vm.provision "shell", inline: <<-SHELL
    echo "=== Обновляем систему ==="
    apt-get update -y
    apt-get install -y python3 python3-pip docker.io curl jq

    echo "=== Добавляем пользователя vagrant в группу docker ==="
    usermod -aG docker vagrant

    echo "=== Настраиваем insecure registry ==="
    mkdir -p /etc/docker
    echo '{"insecure-registries": ["192.168.56.10:5000"]}' > /etc/docker/daemon.json
    systemctl restart docker
    chmod 666 /var/run/docker.sock

    echo "=== Устанавливаем Trivy ==="
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
    mv trivy /usr/local/bin/trivy

    echo "=== Запускаем Docker Registry ==="
    if [ -z "$(docker ps -q -f name=registry)" ]; then
      docker run -d -p 5000:5000 --restart=always --name registry registry:2
    fi

    echo "=== Собираем и сканируем образ приложения ==="
    docker build -t 192.168.56.10:5000/my-app:secure-alpine /vagrant/app
    trivy image --exit-code 0 --severity CRITICAL,HIGH 192.168.56.10:5000/my-app:secure-alpine || true

    echo "=== Push образа в локальный Registry ==="
    docker push 192.168.56.10:5000/my-app:secure-alpine

    echo "=== Развёртываем приложение из Registry ==="
    if [ -n "$(docker ps -q -f name=my-app-secure-alpine)" ]; then
      docker rm -f my-app-secure-alpine
    fi
    docker run -d -p 5001:5000 --name my-app-secure-alpine 192.168.56.10:5000/my-app:secure-alpine

    echo "=== Проверка запущенных контейнеров ==="
    docker ps
  SHELL
end
